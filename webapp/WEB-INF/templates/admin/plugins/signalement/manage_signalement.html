<#include "macro/commons_signalement.html" />
<@adresse_autocomplete_includes/>
<@leaflet_map_includes/>
<@leaflet_cluster_includes/>
<@simpleModal modal_id="map-modal" text=i18n("dansmarue.map.max.results.execeeded",map_max_results)/>

<script type="text/javascript" src="js/sira.js"></script>
<link rel="stylesheet" href="css/plugins/leaflet/leaflet_awesome_number_markers.css" />
<script src="js/leaflet_awesome_number_markers.js"></script>
<script type="text/javascript">

$.ajaxSetup({ cache: false });

function getSigMarkers(){
	var markers = L.markerClusterGroup();
	
	var heatMapData = [];
	
	//Spider
	var oms = new OverlappingMarkerSpiderfier(leafletmap, {keepSpiderfied: true});
	
	$("#map_canvas").addClass("hidden");
	var index=1;
	$.get( "jsp/admin/plugins/signalement/DoGetSignalementsJsonForMap.jsp", function( data ) {
	  data.forEach(function(signalement){
		var color;
		if(signalement.iconName==="greenIcon") {
			color = "green";
		} else if(signalement.iconName==="yellowIcon") {
			color = "orange";
		} else {
			color = "red";
		}
		
		var marker = L.marker([signalement.lat,signalement.lng], {
          icon: new L.AwesomeNumberMarkers({
            number: index, 
            markerColor: color
        })});
		
		marker.bindPopup(signalement.tooltip);
		marker.on('mouseover',function(){this.openPopup()});
		marker.on('mouseout',function(){this.closePopup()});
		marker.on('click',function(){window.open("jsp/admin/plugins/signalement/ViewSignalement.jsp?signalement_id=" + signalement.idSignalement);});
		markers.addLayer(marker);
		oms.addMarker(marker);
		heatMapData.push([signalement.lat,signalement.lng, 0.05]);
		
		
		index++;
	  });
	  
	  leafletmap.addLayer(markers);
	  markers.disableClustering();
	  markers.addTo(leafletmap);
	  
	  var heatLayer = L.heatLayer(heatMapData, {maxZoom:17, radius:30, minOpacity:0.75});
	  
	  $("#map_spinner").addClass("hidden");
	  $("#map_canvas").removeClass("hidden");
	  
	  var overlayMaps = {
		    "Anomalies": markers,
		    "Carte de chaleur": heatLayer
		};
	  
	  L.control.layers(overlayMaps,null).addTo(leafletmap);
	  
	  //A chaque changement de layer, changement du zoom max et de la l�gende
	  leafletmap.on('layeradd', function(eo) {
			if(eo.layer._heat) {
				leafletmap.options.maxZoom = 17;
				$(".legendeGestionAno").html(getLegendHeatMap())
			} else {
				leafletmap.options.maxZoom = 19;
				$(".legendeGestionAno").html(getLegendPin())
			}
		  	
		  	
		  });
	  
	  //Ancienne librairie utilis�e pour l'impression, ne fonctionnais pas sur les vielles version de firefox. A voir pour utilisation si MAJ du navigateur
	  /*L.easyPrint({
			title: 'IMPRIMER',
			position: 'topleft',
			filename: 'carte',
      		exportOnly: true,
      		sizeModes: ['Current', 'A4Landscape', 'A4Portrait'],
			defaultSizeTitles:{ Current: 'Taille actuelle', A4Landscape: 'A4 paysage', A4Portrait: 'A4 portrait'},
		}).addTo(leafletmap);*/
		
		//On enregistre le layer HeatLayer afin de pouvoir l'imprimer
		L.Control.BrowserPrint.Utils.registerLayer( L.HeatLayer, "L.HeatLayer", function(layer) { 
		 return L.heatLayer(layer.getLatLng(), layer.options); 
		} );

		//Ajout de l'impression
		L.control.browserPrint({title: 'IMPRIMER',printModes: ["Landscape"]}).addTo(leafletmap)
	  
	  /*Ajout de la legende*/
	  var legend = L.control({ position: "bottomleft" });

	  legend.onAdd = function(map) {
	    var div = L.DomUtil.create("div", "legendeGestionAno");
	    div.innerHTML = getLegendPin();

	    return div;
	  };
	  
	  legend.addTo(leafletmap);
	  
	  //Fonctions de remplissage des l�gendes
	  function getLegendPin(){
		 var legend = "<h4>Emplacement des anomalies:</h4>";
		 legend += "Les pins sont num&eacute;rot&eacute;s sur la carte et cette num&eacute;rotation est reprise dans la premi&egrave;re colonne de l'export CSV effectu&eacute; depuis la carte";
		 legend += "<br>Pour ajuster la liste des anomalies pr&eacute;sent&eacute;es dans l'export/sur la carte, il faut filtrer au niveau du r&eacute;sultat de la recherche au pr&eacute;alable";
	  	 return legend;
	  }
	  
	  function getLegendHeatMap(){
		 var legend = "<h4>Carte de chaleur:</h4>";
		 legend += "L'intensit&eacute; de la couleur des zones d&eacute;marqu&eacute;es diminue &agrave; mesure qu'on zoom sur la carte";
		 legend += "<br>Le Niveau le plus bas de zoom est celui du quartier";
	  	 return legend;
	  }

		//Ajout du controle d'export des signalements
		 var exportControl =  L.Control.extend({
		  options: {
		    position: 'topleft'
		  },
		
		  onAdd: function (map) {
		    var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom export-leaflet ');
		
		    container.style.backgroundColor = 'white';     
		    container.style.width = '30px';
		    container.style.height = '30px';
		    container.innerHTML = "<a href='jsp/admin/plugins/signalement/DoGetExportForMap.jsp' title='EXPORT CSV'><span class='glyphicon glyphicon-save'></span></a>";
		    
		    return container;
		  }
		});
	  
		//leafletmap.addControl(new printControl());
		leafletmap.addControl(new exportControl());
		
		//leafletmap.setZoom(1);
		leafletmap.options.maxZoom = 17;
	});
	
}

// Update the Sector List with selected Unit (direction)
function updateSectorList(idDirection, isDeleteField){
    if( !(idDirection === void 0) &&  idDirection != "")
    {
        jQuery.ajax( {
            url :"jsp/admin/plugins/signalement/DoGetSectorListByIdDirectionAjax.jsp",
            data: {
                direction_id: idDirection
            },
            success : function(data) { 
                var text = "";
                if(!(data.secteur_list === void 0))
                {
                    var secteurs = data.secteur_list || [];
                    var selectSecteurs = $("#idSector");
                    selectSecteurs.empty();
                    if (secteurs.length > 0) {
                        $.each(secteurs, function(index, secteur){
                                var option = $("<option />").attr("value", secteur.id).text(secteur.value);
                                if ($("#idSelectedSector").val() == secteur.id && !isDeleteField){
                                    option.attr("selected", "selected");
                                }                                   
                                selectSecteurs.append(option);
                        });     
                    }
                }
            },
            error:function (xhr, ajaxOptions, thrownError){
                alert(thrownError); 
            }   
        });
    }
}

function initType(){
	// on recupere la valeur choisi dans la datalist
	var valeurChoisie = $('#typeSignalements').val();
	
	// on recupere les option de la datalist
    var listeOption = $('#idTypeSignalements');
    
	// on recupere l element des option correspondant a la valeur choisie
    var elementOfListe = $(listeOption).find('option[value="' + valeurChoisie + '"]');
    
	// on recupere l id de cette option
    var valeurAsoumettre = elementOfListe.attr('id');
    
	// on affecte la valeur de cette id au typeSignalement 
    $('#idTypeSignalement').val(valeurAsoumettre);      
}

function initTypeValue (){
	
	// on recupere la valeur choisi dans la datalist
	var valeurChoisie = $('#typeSignalements').attr('defaultValue');
	
	if(valeurChoisie =="0"){
		valeurChoisie = "-1";
	}
	
	// on recupere l element des option correspondant a la valeur choisie
    var elementOfListe = $('#idTypeSignalements').find('option[id="'+ valeurChoisie +'"]');
    
	// on recupere l id de cette option
    var valeurAffiche = elementOfListe.attr('value');
    
	// on affecte la valeur de cette id au typeSignalement 
    $('#typeSignalements').attr("value",valeurAffiche);    
	
}

$(document).ready(function() {
    $("#idDirection").change(function(){
        updateSectorList($("#idDirection").val(), false);
        return false;
    });
    updateSectorList($("#idDirection").val(), false);
    
    <#if ((paginator.itemsCount) <= map_max_results)>
		$.getScript("jsp/admin/plugins/signalement/DoGetMap.jsp", function(data){
			initLeafletMap("map_canvas");
			getSigMarkers();
			$(".map_item").addClass("hidden");
		});
		
		$("#display-map-btn").click(function(){
			$(".map_item").removeClass("hidden");
			$("#list-block").addClass("hidden");
			$(".leaflet-control-zoom-in").prop('title', 'Zoomer');
			$(".leaflet-control-zoom-out").prop('title', 'Dezoomer');
		});
	</#if>
    
	var isOptionAvance = false;
	$(".display-advanced-search").click(function(){
		$(".advanced-search-block").toggleClass("hidden");
		
		isOptionAvance = !isOptionAvance;
		$("#btnShowAdvancedSearch").toggleClass('hidden', isOptionAvance);
	});
	
	//Clique sur le bouton de réinitialisation
	$("#re-init-button").click(function(){
		isOptionAvance = false;
		//Hidde les options de recherche avancé
		$(".advanced-search-block").addClass("hidden");
		//Affichage du bouton de recherche avancé
		$("#btnShowAdvancedSearch").removeClass("hidden");
	});
	
	<#if has_advanced_criterias>
	$(".advanced-search-block").toggleClass("hidden");
	isOptionAvance = true
	</#if>
	
	$("#display-list-btn").click(function(){
		$(".map_item").addClass("hidden");
		$("#list-block").removeClass("hidden");
	});
	
    var types = new Array();
	var item;
	<#list type_list as type>
		item = new Object();
		item.libelle = "${type.formatTypeSignalement?js_string}";
		item.value="${type.formatTypeSignalement?js_string}";
// 		item.category="${type.idCategory}";
		types.push(item);
	</#list>
	
	$("#typeSignalements").click(function(){
		$(this).autocomplete("option", "minLength", 0).autocomplete("search", "");
	});
	
	
	$("#typeSignalements").autocomplete({
		source: function(request,response){
// 			var categories = $("input[name='category']:checked").map(function(){
// 			  return $(this).val();
// 			}).get();
			
			var resultList = new Array();
			types.forEach(function(element){
// 				if(categories != undefined && categories.length > 0 && categories.indexOf(element.category) == -1){
// 					return;
// 				}
				if(element.value.toLowerCase().indexOf(request.term.toLowerCase()) != -1){
					resultList.push(element.value);
				}
			});
			response(resultList);
		},
		select: function(event,ui){ $('#typeSignalements').val(ui.item.value);initType();}
	});
	
	initTypeValue();
	initType();
});

	/* S�lection/d�selection des �tats */
	function select_all_states() {
		var checkboxes = $( "label[checkType='etat'] > input");
		$( "label[checkType='etat']").addClass("active");
	  
		for (var i = 0; i < checkboxes.length; i++) {
		  checkboxes[i].checked = true
		}
	}

	function un_select_all_states() {
		var checkboxes = $( "label[checkType='etat'] > input");
		$( "label[checkType='etat']").removeClass("active");
		
		for (var i = 0; i < checkboxes.length; i++) {
		  checkboxes[i].checked = false
		}
	}
	
	/* S�lection/d�selection des arrondissement */
	function select_all_arrondissement() {
		var checkboxes = $( "label[checkType='arrondissement'] > input");
		$( "label[checkType='arrondissement']").addClass("active");
	  
		for (var i = 0; i < checkboxes.length; i++) {
		  checkboxes[i].checked = true
		}
	}

	function un_select_all_arrondissement() {
		var checkboxes = $( "label[checkType='arrondissement'] > input");
		$( "label[checkType='arrondissement']").removeClass("active");
		
		for (var i = 0; i < checkboxes.length; i++) {
		  checkboxes[i].checked = false
		}
	}

</script>
<link rel="stylesheet" href="css/plugins/signalement/signalement.css" type="text/css"/>
<link rel="stylesheet" href="js/jquery/plugins/autocomplete/jquery.autocomplete.css" type="text/css" media="screen, projection" />	

<style>
.ui-autocomplete {
    max-height: 200px;
    overflow-y: auto;
    overflow-x: hidden;
  }
</style>
<div id="overlay"> <div id="text">#i18n{dansmarue.gerenation.carte}</div> </div>
<div id="manage-signalement" class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<div class="box box-info">
			<div class="box-header">
				<h3 class="box-title">#i18n{dansmarue.reportingList.title}</h3>
			</div>

			<div class="box-body">
				<fieldset>
					<form class="form-horizontal"
						action="jsp/admin/plugins/signalement/ManageSignalement.jsp"
						method="post" name="form">

						<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
<#-- 							<div class="form-group"> -->
<#-- 								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12" -->
<#-- 									for="filter_type">Categorie : -->
<#-- 								</label><span id="firt_filter"></span> -->
<#-- 								<div  class="col-xs-12 col-sm-12 col-md-12 col-lg-12 ">	 -->
<#-- 									<div id="categoryCheckboxes" data-toggle="buttons"> -->
<#-- 									<#list category_list as category> -->
<#-- 										<label class="btn btn-checkbox -->
<#-- 										<#if filter.listIdCategories?has_content> -->
<#-- 											<#list filter.listIdCategories as idCategory> -->
<#-- 											<#if category.code == idCategory?c>active</#if></#list> -->
<#-- 										</#if> -->
<#-- 										"> -->
<#-- 											<input type="checkbox"  -->
<#-- 											<#if filter.listIdCategories?has_content> -->
<#-- 											<#list filter.listIdCategories as idCategory> -->
<#-- 												<#if category.code == idCategory?c>checked</#if> -->
<#-- 											</#list> -->
<#-- 											</#if> -->
<#-- 											name="category" value="${category.code}">${category.name}</input> -->
<#-- 										</label> -->
<#-- 									</#list>			 -->
<#-- 									</div>									 -->
<#-- 								</div> -->
<#-- 							</div> -->
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_type">#i18n{dansmarue.reportingList.type}
								</label><span id="firt_filter"></span>
								<div  class="col-xs-12 col-sm-12 col-md-12 col-lg-12 ">	
										
									<input  class="form-control input-sm" id="typeSignalements" value="${idTypeSignalement!}" defaultValue="${(filter.idTypeSignalement)!}"  type="text" placeholder="" maxlength="255" onchange='initType();'/>
									
									<input id="idTypeSignalement" name="idTypeSignalement" defaultValue="-1"  value="" type="hidden" />
									
									<datalist id="idTypeSignalements">											
										<#list type_list as type>
											<option id="${type.id}" value="${type.formatTypeSignalement}">${type.formatTypeSignalement}</option>
										</#list>
									</datalist>														
								</div>
							</div>
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_numero">#i18n{dansmarue.reportingList.number}
									</label>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<input type="text" value="${filter.numero!}"
										class="form-control input-sm" name="numero" id="filter_numero"
										maxlength="255" />
								</div>
							</div>
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_direction">#i18n{dansmarue.reportingList.direction}
									</label>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><#if
									direction_list!?has_content && (direction_list!?size > 1)>
									<@comboWithParams additionalParameters="class='form-control
									input-sm'" name="idDirection"
									default_value="${filter.idDirection!}" items=direction_list />
									<#else> #i18n{dansmarue.reportingList.listEmpty} </#if></div>
							</div>
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_secteur">#i18n{dansmarue.reportingList.entite}
									</label>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<#if secteur_list?has_content && secteur_list?size != 0>
									<@comboWithParams additionalParameters="class='form-control
									input-sm'" name="idSector" default_value="${filter.idSector!}"
									items=secteur_list /> <#else>
									#i18n{dansmarue.reportingList.listEmpty} </#if>
									<noscript>
										<button class="btn btn-primary btn-sm" type="submit"
											name="updateSectorsWithDirection">
											#i18n{dansmarue.commons.refresh}</button>
									</noscript>
								</div>
								<input type="hidden" value="${filter.idSector!}"
									class="<@inputStyle />" name="idSelectedSector"
									id="idSelectedSector" />
							</div>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_dateBegin">
									#i18n{dansmarue.reportingList.creationDate}</label>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<div class="input-daterange">
										<div class="col-xs-1">
											#i18n{dansmarue.reportingList.from}</div>
										<div class="col-xs-3 ">
											<div class="input-group">
												<div class="input-group-addon">
													<span class="glyphicon glyphicon-calendar"></span>
												</div>
												<input class="form-control input-sm" type="text"
													value="${filter.dateBegin!}" name="dateBegin"
													id="filter_dateBegin" maxlength="10" />
											</div>
										</div>
									</div>
									<div class="input-daterange">
										<div class="col-xs-1">#i18n{dansmarue.reportingList.to}
										</div>
										<div class="col-xs-3">
											<div class="input-group">
												<div class="input-group-addon">
													<span class="glyphicon glyphicon-calendar"></span>
												</div>
												<input class="form-control input-sm" type="text"
													value="${filter.dateEnd!}" name="dateEnd"
													id="filter_dateEnd" />
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
									for="filter_typecase">
									#i18n{dansmarue.reportingList.etat}</label>
								<div id="checkbox_etat" class="col-xs-12 col-sm-12 col-md-12 col-lg-12" data-toggle="buttons">
									<#list etat_list as etat>
									<label checkType="etat" class="btn btn-checkbox<#list filter.etats as
											filterEtat> <#if etat.id == filterEtat.id > active
											</#if> </#list>"><input type="checkbox" id="etat${etat.id}" name="etat${etat.id}" value="true"<#list filter.etats as
											filterEtat> <#if etat.id == filterEtat.id > checked="checked"
											</#if> </#list> />${etat.name!}</label>
									</#list>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" data-toggle="buttons">
									<button type="button" class="btn btn-primary" onClick="select_all_states()">#i18n{dansmarue.button.select.all}</button>
									<button type="button" class="btn btn-primary" onClick="un_select_all_states();">#i18n{dansmarue.button.deselect.all}</button>
								</div>
							</div>
						</div>
						<!-- Advanced search -->
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<div class="row hidden advanced-search-block">
								<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
									<div class="form-group">
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_adresse">#i18n{dansmarue.reportingList.adress}
											</label>
										<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
											<input type="text" value="${filter.adresse!}"
												class="form-control input-sm" name="adresse"
												id="filter_adresse" maxlength="255" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_mail">#i18n{dansmarue.reportingList.mail}
										</label>
										<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
											<input type="text" value="${filter.mail!}"
												class="form-control input-sm" name="mail" id="filter_mail"
												maxlength="255" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_commentaire">#i18n{dansmarue.reportingList.comment}
										</label>
										<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
											<input type="text" value="${filter.commentaire!}"
												class="form-control input-sm" name="commentaire"
												id="filter_commentaire" maxlength="255" />
										</div>
									</div>
									<div class="form-group">
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_commentaireAgentTerrain">#i18n{dansmarue.saveSignalement.commentaireAgentTerrain}
										</label>
										<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
											<input type="text" value="${filter.commentaireAgentTerrain!}"
												class="form-control input-sm" name="commentaireAgentTerrain"
												id="filter_commentaireAgentTerrain" maxlength="255" />
										</div>
									</div>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
									<div class="form-group">
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_arrondissement">#i18n{dansmarue.reportingList.arrondissement}
											</label>
											
										<div id="checkbox_arrondissement" class="col-xs-12 col-sm-12 col-md-12 col-lg-12" data-toggle="buttons">
											<#list arrondissement_list as arrondissement>
												<label checkType="arrondissement" class="btn btn-checkbox <#if (filter.listIdArrondissements)?has_content && filter.listIdArrondissements?seq_contains(arrondissement.code?number)>active</#if>"><input type="checkbox" name="listIdArrondissementsParam" <#if (filter.listIdArrondissements)?has_content && filter.listIdArrondissements?seq_contains(arrondissement.code?number)>checked</#if> value="${arrondissement.code}"/>${arrondissement.name!}</label>
											</#list>
										</div>
										<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" data-toggle="buttons">
											<button type="button" class="btn btn-primary" onClick="select_all_arrondissement()">#i18n{dansmarue.button.select.all}</button>
											<button type="button" class="btn btn-primary" onClick="un_select_all_arrondissement()">#i18n{dansmarue.button.deselect.all}</button>
										</div>
										
										<label class="col-xs-12 col-sm-12 col-md-12 col-lg-12"
											for="filter_arrondissement">#i18n{dansmarue.reportingList.quartier}
										</label>
											
										<div id="" class="col-xs-12 col-sm-12 col-md-12 col-lg-12" data-toggle="buttons">
											<select name="listIdQuartierParam"  id="conseilQuartier" class="selectpicker show-menu-arrow form-control" data-width="300px" data-size="10" multiple data-actions-box="true" data-live-search="true">
												<#list conseilQuartier_list as conseilQuartier>
													<option value="${conseilQuartier.idConsqrt}" <#if (filter.listIdQuartier?has_content && filter.listIdQuartier?seq_contains(conseilQuartier.idConsqrt?number))>selected</#if> >${conseilQuartier.nomConsqrt}</option>
												</#list>
											</select>
										</div>
									</div>
								</div>
							</div>
						</div>
						<#if dashboard_criterias?has_content>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="dashboard_criterias">
										<#list dashboard_criterias as key,valueList>
											<label>${key} :</label> <#list valueList as value>${value!}<#sep>, </#sep></#list>
											<#sep> - </#sep>
										</#list>
								</div>
						</#if>
						<div class="text-center">
							<div class="form-group">
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<span id="btnShowAdvancedSearch" class="advanced-search-block display-advanced-search">#i18n{dansmarue.reportingList.displayAdvancedSearch}</span>
									<span class="advanced-search-block hidden display-advanced-search">#i18n{dansmarue.reportingList.hideAdvancedSearch}</span>
								</div>
							</div>
							<style>
								
							</style>
							<div class="form-group">
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<button type="submit" class="btn btn-paris btn-red btn-lg"
										id="search-button" name="search">
										#i18n{dansmarue.reportingList.search}
									</button>
									<button type="button" class="btn btn-paris btn-blue btn-lg"
										id="re-init-button" onclick="deleteFields()">
										#i18n{dansmarue.reportingList.reInitChamps}
									</button>

								</div>
							</div>
						</div>
					</form>
				</fieldset>
			<#if ((paginator.itemsCount) <= map_max_results)>
			<fieldset>
				<div class="row">
					<div id="toggle-map-btns" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div class="btn-group" data-toggle="buttons">
						  <label class="btn toggle-map-btns"  id="display-map-btn">
							<input type="radio" name="options" autocomplete="off"><img id="map-icon" class="svg toggle-icon" src="images/admin/skin/plugins/signalement/map-icon.svg"/><label>Carte</label>
						  </label>
						  <label class="btn toggle-map-btns active"  id="display-list-btn">
							<input type="radio" name="options"  autocomplete="off" checked><img id="list-icon" class="svg toggle-icon" src="images/admin/skin/plugins/signalement/list-icon.svg"/><label>Liste</label>
						  </label>
						</div>
						<div id="map_nb_result_div" class="map_item pull-right hidden">
							<label class="label-title">#i18n{dansmarue.reportingList.search.results} : </label><span> ${(paginator.itemsCount)} #i18n{dansmarue.reportingList.present.anomalies}</span>
						</div>
					</div>
				</div>
			</fieldset>
			<fieldset id="map-block" class="map_item">
				<div class="row">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div id="map_spinner" class="text-center"><i class="fa fa-spinner fa-spin" style="font-size:24px"></i><br/>#i18n{dansmarue.map.loading}</div>
						<div id="map_canvas" style="height:800px;z-index:1;">
						</div>
					</div>
				</div>
			</fieldset>
			<#else>
				<fieldset>
				<div class="row">
					<div id="toggle-map-btns" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<div class="btn-group">
						  <button class="btn toggle-map-btns" data-toggle="modal" data-target="#map-modal"><img id="map-icon" class="svg toggle-icon" src="images/admin/skin/plugins/signalement/map-icon.svg"/><label>Carte</label></button>
						  <button class="btn toggle-map-btns active"><img id="list-icon" class="svg toggle-icon" src="images/admin/skin/plugins/signalement/list-icon.svg"/><label>Liste</label></button>
						</div>
					</div>
				</div>
			</fieldset>
			</#if>
			<fieldset id="list-block">
				<@paginationSig paginator=paginator combo=1 />
				<form action="jsp/admin/plugins/signalement/ProcessAction.jsp"
					method="post">
					<div class="pull-left">
						<!-- creation Signalement/exportCSV/exportAllCSV/serviceFait/Programmer/Reprogrammer -->
						<@a class="btn btn-xs btn-primary"
						additionalParameters="title='#i18n{dansmarue.caseList.CreateSignalement}'"
						visu=false
						href="jsp/admin/plugins/signalement/SaveSignalement.jsp"> <i
							class="glyphicon glyphicon-plus"></i> </@a>

						<!-- export en input pour r�cup�rer les dossiers coch�s -->
						<@estAutoriseMacro ressourceType="GESTION_DES_SIGNALEMENTS"
						permission="EXPORTER_SIGNALEMENT">
						<button type="submit" value="exportcsv"
							title="#i18n{dansmarue.caseList.ExportSignalement}"
							name="exportcsv" class="btn btn-xs btn-primary">
							<i class="glyphicon glyphicon-save"></i>
						</button>
						</@estAutoriseMacro> 
						
						<#if hasSignalementPrestataire >
						
							<@estAutoriseMacro
							ressourceType="GESTION_DES_SIGNALEMENTS"
							permission="TRAITEMENT_MASSE">
							<button class="btn btn-xs btn-primary" type="submit" value="4"
								id="button-fait-masse" name="servicefait"
								title="#i18n{dansmarue.caseList.ServiceFaitMasse}" disabled>
								<i class="glyphicon glyphicon-ok"></i>
							</button>						
							<button class="btn btn-xs btn-primary" type="submit" value="5"
								id="button-programmer-masse" name="programmer"
								title="#i18n{dansmarue.caseList.ProgrammerMasse}" disabled>
								<i class="glyphicon glyphicon-calendar"></i>
							</button>
							<button class="btn btn-xs btn-primary" type="submit" value="6"
								id="button-reprogrammer-masse" name="reprogrammer"
								title="#i18n{dansmarue.caseList.ReprogrammerMasse}" disabled>
								<i class="glyphicon glyphicon-refresh"></i>
							</button>
							</@estAutoriseMacro>
							<@estAutoriseMacro
							ressourceType="GESTION_DES_SIGNALEMENTS"
							permission="SUPPRIMER_SIGNALEMENT_MASSE">
							<button class="btn btn-xs btn-primary" type="submit" value="7"
								id="button-supprimer-masses" name="masse_deletes"
								title="#i18n{dansmarue.caseList.SupprimerMasse}" disabled>
								<i class="glyphicon glyphicon-trash"></i>
							</button>
							
							</@estAutoriseMacro>
						
						<#else>
						
							<@estAutoriseMacro
							ressourceType="GESTION_DES_SIGNALEMENTS"
							permission="TRAITEMENT_MASSE">
							<button class="btn btn-xs btn-primary" type="submit" value="4"
								id="button-fait-masse" name="servicefait"
								title="#i18n{dansmarue.caseList.ServiceFaitMasse}">
								<i class="glyphicon glyphicon-ok"></i>
							</button>
							<button class="btn btn-xs btn-primary" type="submit" value="5"
								id="button-programmer-masse" name="programmer"
								title="#i18n{dansmarue.caseList.ProgrammerMasse}">
								<i class="glyphicon glyphicon-calendar"></i>
							</button>
							<button class="btn btn-xs btn-primary" type="submit" value="6"
								id="button-reprogrammer-masse" name="reprogrammer"
								title="#i18n{dansmarue.caseList.ReprogrammerMasse}">
								<i class="glyphicon glyphicon-refresh"></i>
							</button>
							</@estAutoriseMacro>
							<@estAutoriseMacro
							ressourceType="GESTION_DES_SIGNALEMENTS"
							permission="SUPPRIMER_SIGNALEMENT_MASSE">
							<button class="btn btn-xs btn-primary" type="submit" value="7"
								id="button-supprimer-masses" name="masse_deletes"
								title="#i18n{dansmarue.caseList.SupprimerMasse}">
								<i class="glyphicon glyphicon-trash"></i>
							</button>
						
							</@estAutoriseMacro>
						</#if>
						
					</div>
					<br />
					<br />
					<table id="table-signalements" class="table table-condensed">
						<thead>
							<tr>
								<@hasAutorisationMacro ressourceType="GESTION_DES_SIGNALEMENTS"
								permissions=["TRAITEMENT_MASSE","SUPPRIMER_SIGNALEMENT_MASSE","EXPORTER_SIGNALEMENT"]>
								<th><input type="checkbox" name="selectAll" id="selectAll"
									value="selectAll"
									title="#i18n{dansmarue.reportingList.alt.selectAll}" /></th> </@hasAutorisationMacro>
								<th>#i18n{dansmarue.reportingList.actions}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="photo.id_photo"/>#i18n{dansmarue.reportingList.photo}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="signalement.suivi"/>#i18n{dansmarue.reportingList.nbfollowers}</th>
									<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="signaleur.mail"/>#i18n{dansmarue.reportingList.mail}</th> 
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="numSignalement"/>#i18n{dansmarue.reportingList.number}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="priorite.libelle"/>#i18n{dansmarue.reportingList.priority}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="type.libelle"/>#i18n{dansmarue.reportingList.type}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="direction_unit.label"/>#i18n{dansmarue.reportingList.direction}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="adr.adresse"/>#i18n{dansmarue.reportingList.adress}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="signalement.commentaire"/>#i18n{dansmarue.reportingList.comment}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="signalement.commentaireAgentTerrain"/>#i18n{dansmarue.saveSignalement.commentaireAgentTerrain}</th>
								<th><@sort
									jsp_url="jsp/admin/plugins/signalement/ManageSignalement.jsp"
									attribute="signalement.date_creation"/>#i18n{dansmarue.reportingList.creationDate}</th>
								<th>#i18n{dansmarue.reportingList.etat}</th>
							</tr>
						</thead>
						<tbody>
							<#if signalement_list?has_content> <#list signalement_list as
							signalement>
							<tr id="ancre-signalement-${signalement.id}"
								class="signalement-list-element">
								<@hasAutorisationMacro ressourceType="GESTION_DES_SIGNALEMENTS"
								permissions=["TRAITEMENT_MASSE","SUPPRIMER_SIGNALEMENT_MASSE","EXPORTER_SIGNALEMENT"]>
								<td class="signalement-checkbox"><input type="checkbox"
									name="signalement_id" value="${signalement.id}"
									title="#i18n{dansmarue.reportingList.alt.select}" /></td>
								</@hasAutorisationMacro>
								<td class="signalement-actions">
								
									<@a class="btn btn-xs
									btn-primary" visu=false
									href="jsp/admin/plugins/signalement/ViewSignalement.jsp"
									params="?signalement_id=${signalement.id}"
									additionalParameters="title='#i18n{dansmarue.reportingList.alt.view}'"> <i
									class="glyphicon glyphicon-eye-open"></i> </@a> 
									
									<#if !(signalement.isSendWS) >
										<@a class="btn
										btn-xs btn-primary" visu=false
										sector=(signalement.secteur.idSector)!?string
										href="jsp/admin/plugins/signalement/ModifySignalement.jsp"
										params="?signalement_id=${signalement.id}"
										additionalParameters="title='#i18n{dansmarue.reportingList.alt.modify}'">
										<i class="glyphicon glyphicon-edit"></i> </@a> 
									</#if>
									
									<a
									class="btn btn-xs btn-primary"
									title="#i18n{dansmarue.reportingList.alt.history}"
									href="jsp/admin/plugins/signalement/ViewHistory.jsp?signalement_id=${signalement.id}">
										<i class="glyphicon glyphicon-book"></i>
									</a> 
									
									<#assign list_actions = map_actions[signalement.id?string] />
									<#-- actions du workflow --> 
									<#list list_actions as action>
									<#if
									rights.estAutorise("*","*",(signalement.secteur.idSector)!?string)>
									
									<a title="${action.name}"
									href="jsp/admin/plugins/signalement/ProcessAction.jsp?action_id=${action.id}&amp;signalement_id=${signalement.id}">
										<img width="24px"
										src="image?resource_type=workflow_icon_img&id=${action.icon.id}"
										alt="${action.name}" />
									</a> </#if> 
									
									</#list> 
									
									<#if !(signalement.isSendWS) >
									<@a class="btn btn-xs btn-danger" visu=false
									sector=(signalement.secteur.idSector)!?string
									href="jsp/admin/plugins/signalement/DeleteSignalement.jsp"
									params="?signalement_id=${signalement.id}"
									additionalParameters="title='#i18n{dansmarue.commons.supprimer}'">
									<i class="glyphicon glyphicon-trash"></i> </@a> 
									</#if>
									
									<@a class="btn
									btn-xs btn-primary" visu=false
									sector=(signalement.secteur.idSector)!?string
									href="jsp/admin/plugins/signalement/DoCreateMailSignalement.jsp"
									params="?signalement_id=${signalement.id}"
									additionalParameters="title='#i18n{dansmarue.commons.mail}'"> <i
									class="glyphicon glyphicon-envelope"></i> </@a>

								</td>


								<td class="signalement-photo">
									<#if signalement.photos?has_content> 
										<#assign isHidden = false>
										<#list signalement.photos as photo> 
											<span id='${signalement.id}'>
												<a href='#' data-toggle="modal" data-target="#imageModal" id-vue='${photo.vue}' id-signalement='${signalement.id}' image-url='${photo.imageUrl}' <#if isHidden> style='display: none'</#if>>
													<img src="${photo.imageThumbnailUrl}" width="100" />
												</a>
											</span>
											<#assign isHidden = true>
										</#list>
									</#if>
								</td>
								<td class="signalement-suivi">${signalement.suivi!}</td>
								<td class="signalement-mail">${(signalement.signaleurs[0].mail)!}</td>
								<td class="signalement-id"><@a class="link" visu=true
									href="jsp/admin/plugins/signalement/ViewSignalement.jsp"
									params="?signalement_id=${signalement.id}">${signalement.numeroSignalement!}</@a></td>
								<td class="signalement-priorite">${signalement.prioriteName!}</td>
								<td class="signalement-type">${signalement.type!}</td>
								<td class="signalement-direction">${(signalement.directionSector.label)!}</td>
								<td class="signalement-address"><@a class="link"  visu=true
									href="jsp/admin/plugins/signalement/ViewSignalement.jsp"
									params="?signalement_id=${signalement.id}">${signalement.adresses[0].adresse!}</@a></td>
								<td class="signalement-comment">${signalement.commentaire!}</td>
								<td class="signalement-comment">${signalement.commentaireAgentTerrain!}</td>
								<td class="signalement-date">${signalement.dateCreation!}</td>
								<td class="signalement-etat">${map_etats[signalement.id?string]!}</td>
							</tr>
							</#list> <#else>
							<tr>
								<td colspan="12">
									#i18n{dansmarue.reportingList.messageNoResult}</td>
							</tr>
							</#if>
						</tbody>
					</table>
					<div class="pull-left">
						<!-- creation Signalement/exportCSV/exportAllCSV/serviceFait/Programmer/Reprogrammer -->
						<@a class="btn btn-xs btn-primary"
						additionalParameters="title='#i18n{dansmarue.caseList.CreateSignalement}'"
						visu=false
						href="jsp/admin/plugins/signalement/SaveSignalement.jsp"> <i
							class="glyphicon glyphicon-plus"></i> </@a>

						<!-- export en input pour r�cup�rer les dossiers coch�s -->
						<@estAutoriseMacro ressourceType="GESTION_DES_SIGNALEMENTS"
						permission="EXPORTER_SIGNALEMENT">
						<button type="submit" value="exportcsv"
							title="#i18n{dansmarue.caseList.ExportSignalement}"
							name="exportcsv" class="btn btn-xs btn-primary">
							<i class="glyphicon glyphicon-save"></i>
						</button>
						</@estAutoriseMacro> <@estAutoriseMacro
						ressourceType="GESTION_DES_SIGNALEMENTS"
						permission="TRAITEMENT_MASSE">
						<button class="btn btn-xs btn-primary" type="submit" value="4"
							id="button-fait-masse" name="servicefait"
							title="#i18n{dansmarue.caseList.ServiceFaitMasse}">
							<i class="glyphicon glyphicon-ok"></i>
						</button>
						<button class="btn btn-xs btn-primary" type="submit" value="5"
							id="button-programmer-masse" name="programmer"
							title="#i18n{dansmarue.caseList.ProgrammerMasse}">
							<i class="glyphicon glyphicon-calendar"></i>
						</button>

						<button class="btn btn-xs btn-primary" type="submit" value="6"
							id="button-reprogrammer-masse" name="reprogrammer"
							title="#i18n{dansmarue.caseList.ReprogrammerMasse}">
							<i class="glyphicon glyphicon-refresh"></i>
						</button>
						</@estAutoriseMacro>
						<@estAutoriseMacro
						ressourceType="GESTION_DES_SIGNALEMENTS"
						permission="SUPPRIMER_SIGNALEMENT_MASSE">
						<button class="btn btn-xs btn-primary" type="submit" value="7"
							id="button-supprimer-masses" name="masse_deletes"
							title="#i18n{dansmarue.caseList.SupprimerMasse}">
							<i class="glyphicon glyphicon-trash"></i>
						</button>
						</@estAutoriseMacro>
					</div>
				</form>
				<@paginationSig paginator=paginator combo=1 />
			</fieldset>
		</div>
	</div>
</div>
</div>
<@getDatePickerRangeBootstrap language="${locale.language!}" />
<@modalImage/>
<script type="text/javascript">
	var idEtatsDefault = new Array();
	<#list etats_default as etat_id>idEtatsDefault.push('etat${etat_id}');</#list>

    $("#selectAll").change(  function() {
        if ( this.checked )
        {
            // select all
            $("input[name='signalement_id']").prop( "checked", "checked");
        }
        else
        {
            $("input[name='signalement_id']").prop( "checked", "");
        }
    });
    
    function deleteFields()
    {
        //$('#idTypeSignalement option:selected').removeAttr('selected');
       // $('#idTypeSignalement option:first').attr("selected", "selected");
       	$("#idTypeSignalement").val('');
       	$("#typeSignalements").val('');
        $("#filter_numero").val('');
        $('#idDirection option:selected').removeAttr('selected');
        $('#idDirection option:first').attr("selected", "selected");
        $('#idSector option:selected').removeAttr('selected');
        $('#idSector option:first').attr("selected", "selected");
        updateSectorList(-1, true);
        $("#filter_adresse").val('');
        $("#filter_mail").val('');
        $("#filter_commentaire").val('');
        $("#filter_commentaireAgentTerrain").val('');
        $("#filter_dateBegin").val('');
        $("#filter_dateEnd").val('');
        $("#dashboardCriterias").html("");
		
		$("#conseilQuartier").selectpicker('val', '');
        $("#conseilQuartier").selectpicker('refresh');
        
// 		$("#categoryCheckboxes .btn-checkbox").removeClass("active");
// 		$("input[name='category']").attr('checked',false);
		
		$("#checkbox_arrondissement input:checkbox").attr('checked',false);
		$("#checkbox_arrondissement label").removeClass("active");
		
        $("#checkbox_etat input:checkbox").attr('checked',false);
		$("#checkbox_etat label").removeClass("active");
		$("#checkbox_etat input:checkbox").each(function(index,data){
	       	var dataId = $(data).attr('id');
			if(idEtatsDefault.indexOf(dataId) > -1){
				$(data).parent().addClass("active");
				data.checked= true;
			}
       	});
		
		$("#dashboard_criterias").hide();
		 
    }
</script>

<script src="js/jquery.cookie.js"></script>
<script src="js/html2canvas.min.js"></script>
<script src="js/canvas2image.js"></script>

<script>
$(window).load(function() {
    var doneOnce = false;
    if(/chrom(e|ium)/.test(navigator.userAgent.toLowerCase())){
        $("#album-button").show().click(function() {
            if(!doneOnce) {
                $("td.signalement-photo>img").each(function() {
                    var idImg = $(this).attr("src").split("id=")[1];
                    var strUrlImg = "image?resource_type=photo_signalement&id=" + idImg;
                    var offsetMiniature = $(this).offset().top;
                    $("<img src='"+strUrlImg+"' id='grande"+idImg+"' style='max-width:900px' alt='Cliquer pour revenir aux actions'>").appendTo($('body')).click(function() {
                        $('html, body').animate({scrollTop:offsetMiniature});
                    });
                    
                    $(this).click(function() {
                        var idImg = $(this).attr("src").split("id=")[1];
                        var offsetGrandeImage = $("#grande"+idImg).offset().top; 
                        $('html, body').animate({scrollTop:offsetGrandeImage});
                    });
                });
                doneOnce = true;
            }
            $('html, body').animate({scrollTop:$("#main-footer").offset().top});
        });
    }
});


$(document).ready(function() {
	$.getScript("jsp/admin/plugins/leaflet/DoGetAutocomplete.jsp", function(data){
		addAutocomplete("filter_adresse",null);
	});
});

</script>